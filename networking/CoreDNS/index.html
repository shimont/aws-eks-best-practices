
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../loadbalancing/loadbalancing/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.2">
    
    
      
        <title>Monitoring for DNS Throttling Issues - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.f56500e0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#monitoring-coredns-traffic-for-dns-throttling-issues" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="EKS Best Practices Guides" class="md-header__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS Best Practices Guides
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Monitoring for DNS Throttling Issues
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws/aws-eks-best-practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/iam/" class="md-nav__link">
        Identity and Access Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/pods/" class="md-nav__link">
        Pod Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/multitenancy/" class="md-nav__link">
        Multi-tenancy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/detective/" class="md-nav__link">
        Detective Controls
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/network/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/data/" class="md-nav__link">
        Data Encryption and Secrets Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/runtime/" class="md-nav__link">
        Runtime Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/hosts/" class="md-nav__link">
        Infrastructure Security
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/compliance/" class="md-nav__link">
        Regulatory Compliance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/incidents/" class="md-nav__link">
        Incident Response and Forensics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/docs/image/" class="md-nav__link">
        Image Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Cluster Autoscaling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Cluster Autoscaling
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../karpenter/" class="md-nav__link">
        Karpenter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cluster-autoscaling/" class="md-nav__link">
        Cluster-Autoscaler
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Reliability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reliability" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Reliability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/application/" class="md-nav__link">
        Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/controlplane/" class="md-nav__link">
        Control Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/dataplane/" class="md-nav__link">
        Data Plane
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reliability/docs/networkmanagement/" class="md-nav__link">
        Network
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Windows Containers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Windows Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/ami/" class="md-nav__link">
        AMI Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/gmsa/" class="md-nav__link">
        gMSA for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/hardening/" class="md-nav__link">
        Windows Server Hardening
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/heterogeneous/" class="md-nav__link">
        Running Mixed Workloads
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/images/" class="md-nav__link">
        Scanning Windows Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/licensing/" class="md-nav__link">
        Windows Versions and Licensing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/monitoring/" class="md-nav__link">
        Monitoring Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/networking/" class="md-nav__link">
        Windows Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/oom/" class="md-nav__link">
        Memory and Systems Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/patching/" class="md-nav__link">
        Infrastructure Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/scheduling/" class="md-nav__link">
        Scheduling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/security/" class="md-nav__link">
        Pod Security for Windows Containers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/docs/storage/" class="md-nav__link">
        Storage Options
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Networking
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Networking" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Networking
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../index/" class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../subnets/" class="md-nav__link">
        VPC and Subnet Considerations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../vpc-cni/" class="md-nav__link">
        Amazon VPC CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../prefix-mode/" class="md-nav__link">
        Prefix Mode
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ipv6/" class="md-nav__link">
        Running IPv6 Clusters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sgpp/" class="md-nav__link">
        Security Groups per Pod
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../custom-networking/" class="md-nav__link">
        Custom Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../loadbalancing/loadbalancing/" class="md-nav__link">
        Load Balancing
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Monitoring for DNS Throttling Issues
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Monitoring for DNS Throttling Issues
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#challenge" class="md-nav__link">
    Challenge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capturing-the-metrics-to-identify-throttling-issues" class="md-nav__link">
    Capturing the metrics to identify throttling issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-prometheus-ethtool-exporter" class="md-nav__link">
    Deploying Prometheus ethtool exporter
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-adot-collector-to-scrape-the-ethtool-metrics-and-store-in-amazon-managed-service-for-prometheus-workspace" class="md-nav__link">
    Deploy the ADOT collector to scrape the ethtool metrics and store in Amazon Managed Service for Prometheus workspace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-alert-manager-in-amazon-managed-service-for-prometheus-to-send-notifications" class="md-nav__link">
    Configure alert manager in Amazon Managed Service for Prometheus to send notifications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualize-ethtool-metrics-in-amazon-managed-grafana" class="md-nav__link">
    Visualize ethtool metrics in Amazon Managed Grafana
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#challenge" class="md-nav__link">
    Challenge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#capturing-the-metrics-to-identify-throttling-issues" class="md-nav__link">
    Capturing the metrics to identify throttling issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-prometheus-ethtool-exporter" class="md-nav__link">
    Deploying Prometheus ethtool exporter
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-the-adot-collector-to-scrape-the-ethtool-metrics-and-store-in-amazon-managed-service-for-prometheus-workspace" class="md-nav__link">
    Deploy the ADOT collector to scrape the ethtool metrics and store in Amazon Managed Service for Prometheus workspace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-alert-manager-in-amazon-managed-service-for-prometheus-to-send-notifications" class="md-nav__link">
    Configure alert manager in Amazon Managed Service for Prometheus to send notifications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualize-ethtool-metrics-in-amazon-managed-grafana" class="md-nav__link">
    Visualize ethtool metrics in Amazon Managed Grafana
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="monitoring-coredns-traffic-for-dns-throttling-issues">Monitoring CoreDNS traffic for DNS throttling issues<a class="headerlink" href="#monitoring-coredns-traffic-for-dns-throttling-issues" title="Permanent link">&para;</a></h1>
<p>Running DNS intensive workloads can sometimes experience intermittent CoreDNS failures due to DNS throttling, and this can impact applications where you may encounter occasional UnknownHostException errors.</p>
<p>The Deployment for CoreDNS has an anti-affinity policy that instructs the Kubernetes scheduler to run instances of CoreDNS on separate worker nodes in the cluster, i.e. it should avoid co-locating replicas on the same worker node. This effectively reduces the number of DNS queries per network interface because traffic from each replica is routed through a different ENI. If you notice that DNS queries are being throttled because of the 1024 packets per second limit, you can 1) try increasing the number of CoreDNS replicas or 2) implement <a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/">NodeLocal DNSCache</a>. See <a href="https://aws.github.io/aws-eks-best-practices/reliability/docs/networkmanagement/#monitor-coredns-metrics">Monitor CoreDNS Metrics</a> for further information.</p>
<h2 id="challenge">Challenge<a class="headerlink" href="#challenge" title="Permanent link">&para;</a></h2>
<ul>
<li>Packet drop happens in seconds and it can be tricky for us to properly monitor these patterns to determine if DNS throttling is actually happening.</li>
<li>DNS queries are throttled at the elastic network interface level. So, throttled queries don't appear in the query logging. </li>
<li>Flow logs do not capture all IP traffic. E.g. Traffic generated by instances when they contact the Amazon DNS server. If you use your own DNS server, then all traffic to that DNS server is logged</li>
</ul>
<h2 id="capturing-the-metrics-to-identify-throttling-issues">Capturing the metrics to identify throttling issues<a class="headerlink" href="#capturing-the-metrics-to-identify-throttling-issues" title="Permanent link">&para;</a></h2>
<p>An easy way to identify the DNS throttling issues in worker nodes is by capturing few key network performance metrics. The Elastic Network Adapter (ENA ) driver publishes network performance metrics from the instances where they are enabled. You can troubleshoot DNS throttling using the <code>linklocal_allowance_exceeded</code> metric. The <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/metrics-collected-by-CloudWatch-agent.html#linux-metrics-enabled-by-CloudWatch-agent">linklocal_allowance_exceeded</a> is number of packets dropped because the PPS of the traffic to local proxy services exceeded the maximum for the network interface. This impacts traffic to the DNS service, the Instance Metadata Service, and the Amazon Time Sync Service. Instead of tracking this event real-time, we can stream this metric to <a href="https://aws.amazon.com/prometheus/">Amazon Managed Service for Prometheus</a> and have them visualized in <a href="https://aws.amazon.com/grafana/">Amazon Managed Grafana</a></p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>ethtool - Ensure the worker nodes have ethtool installed</li>
<li>An AMP workspace configured in your AWS account. For instructions, see <a href="https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-onboard-create-workspace.html">Create a workspace</a> in the AMP User Guide.</li>
<li>Amazon Managed Grafana Workspace</li>
</ul>
<h2 id="deploying-prometheus-ethtool-exporter">Deploying Prometheus ethtool exporter<a class="headerlink" href="#deploying-prometheus-ethtool-exporter" title="Permanent link">&para;</a></h2>
<p>The deployment contains a python script that pulls information from ethtool and publishes it in prometheus format.</p>
<div class="codehilite"><pre><span></span><code><span class="n">kubectl</span><span class="w"> </span><span class="n">apply</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Showmax</span><span class="o">/</span><span class="n">prometheus</span><span class="o">-</span><span class="n">ethtool</span><span class="o">-</span><span class="n">exporter</span><span class="o">/</span><span class="k">master</span><span class="o">/</span><span class="n">deploy</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">daemonset</span><span class="o">.</span><span class="n">yaml</span>
</code></pre></div>

<h2 id="deploy-the-adot-collector-to-scrape-the-ethtool-metrics-and-store-in-amazon-managed-service-for-prometheus-workspace">Deploy the ADOT collector to scrape the ethtool metrics and store in Amazon Managed Service for Prometheus workspace<a class="headerlink" href="#deploy-the-adot-collector-to-scrape-the-ethtool-metrics-and-store-in-amazon-managed-service-for-prometheus-workspace" title="Permanent link">&para;</a></h2>
<p>Each cluster where you install AWS Distro for OpenTelemetry (ADOT) must have this role to grant your AWS service account permissions to store metrics into Amazon Managed Service for Prometheus. Follow these steps to create and associate your IAM role to your Amazon EKS service account using IRSA:</p>
<div class="codehilite"><pre><span></span><code><span class="n">eksctl</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">iamserviceaccount</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">adot</span><span class="o">-</span><span class="n">collector</span><span class="w"> </span><span class="o">--</span><span class="n">namespace</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="o">--</span><span class="n">cluster</span><span class="w"> </span><span class="o">&lt;</span><span class="n">CLUSTER_NAME</span><span class="o">&gt;</span><span class="w"> </span><span class="o">--</span><span class="n">attach</span><span class="o">-</span><span class="n">policy</span><span class="o">-</span><span class="n">arn</span><span class="w"> </span><span class="nl">arn:aws:</span><span class="n">iam</span><span class="o">::</span><span class="nl">aws:</span><span class="n">policy</span><span class="o">/</span><span class="n">AmazonPrometheusRemoteWriteAccess</span><span class="w"> </span><span class="o">--</span><span class="n">attach</span><span class="o">-</span><span class="n">policy</span><span class="o">-</span><span class="n">arn</span><span class="w"> </span><span class="nl">arn:aws:</span><span class="n">iam</span><span class="o">::</span><span class="nl">aws:</span><span class="n">policy</span><span class="o">/</span><span class="n">AWSXrayWriteOnlyAccess</span><span class="w"> </span><span class="o">--</span><span class="n">attach</span><span class="o">-</span><span class="n">policy</span><span class="o">-</span><span class="n">arn</span><span class="w"> </span><span class="nl">arn:aws:</span><span class="n">iam</span><span class="o">::</span><span class="nl">aws:</span><span class="n">policy</span><span class="o">/</span><span class="n">CloudWatchAgentServerPolicy</span><span class="w"> </span><span class="o">--</span><span class="n">region</span><span class="w"> </span><span class="o">&lt;</span><span class="n">REGION</span><span class="o">&gt;</span><span class="w"> </span><span class="o">--</span><span class="n">approve</span><span class="w">  </span><span class="o">--</span><span class="n">override</span><span class="o">-</span><span class="n">existing</span><span class="o">-</span><span class="n">serviceaccounts</span>
</code></pre></div>

<p>Let's deploy the ADOT collector to scrape the metrcis from the prometheus ethtool exporter and store it in Amazon Managed Service for Prometheus</p>
<p>The following procedure uses an example YAML file with deployment as the mode value. This is the default mode and deploys the ADOT Collector similarly to a standalone application. This configuration receives OTLP metrics from the sample application and Amazon Managed Service for Prometheus metrics scraped from pods on the cluster</p>
<div class="codehilite"><pre><span></span><code>curl -o collector-config-amp.yaml https://raw.githubusercontent.com/aws-observability/aws-otel-community/master/sample-configs/operator/collector-config-amp.yaml
</code></pre></div>

<p>In collector-config-amp.yaml, replace the following with your own values:
* mode: deployment
* serviceAccount: adot-collector
* endpoint: "<YOUR_REMOTE_WRITE_ENDPOINT>"
* region: "<YOUR_AWS_REGION>"
* name: adot-collector</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f collector-config-amp.yaml 
</code></pre></div>

<p>Once the adot collector is deployed, the metrics will be stored successfully in Amazon Prometheus</p>
<h2 id="configure-alert-manager-in-amazon-managed-service-for-prometheus-to-send-notifications">Configure alert manager in Amazon Managed Service for Prometheus to send notifications<a class="headerlink" href="#configure-alert-manager-in-amazon-managed-service-for-prometheus-to-send-notifications" title="Permanent link">&para;</a></h2>
<p>Let's configure recording rules and alerting rules to check for the metric captured <code>linklocal_allowance_exceeded</code>. The <code>linklocal_allowance_exceeded</code> denotes the number of packets dropped due to PPS rate allowance exceeded for local services such as Route 53 DNS Resolver, Instance Metadata Service, Amazon Time Sync Service. You should receive alerts the moment it exceeds the value 0, meaning there shouldn't be any packet drops.</p>
<p>We will use the <a href="https://github.com/aws-controllers-k8s/prometheusservice-controller">ACK Controller for Amazon Managed Service for Prometheus</a> to provision the alerting and recording rules.</p>
<p>Let's deploy the ACL controller for the Amazon Managed Service for Prometheus service:</p>
<div class="codehilite"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">SERVICE</span><span class="o">=</span><span class="n">prometheusservice</span>
<span class="k">export</span><span class="w"> </span><span class="n">RELEASE_VERSION</span><span class="o">=</span><span class="err">`</span><span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">sL</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">api</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">controllers</span><span class="o">-</span><span class="n">k8s</span><span class="o">/$</span><span class="n">SERVICE</span><span class="o">-</span><span class="n">controller</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">latest</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="s1">&#39;&quot;tag_name&quot;:&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cut</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="o">-</span><span class="n">f4</span><span class="err">`</span>
<span class="k">export</span><span class="w"> </span><span class="n">ACK_SYSTEM_NAMESPACE</span><span class="o">=</span><span class="n">ack</span><span class="o">-</span><span class="n">system</span>
<span class="k">export</span><span class="w"> </span><span class="n">AWS_REGION</span><span class="o">=</span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span>
<span class="n">aws</span><span class="w"> </span><span class="n">ecr</span><span class="o">-</span><span class="n">public</span><span class="w"> </span><span class="n">get</span><span class="o">-</span><span class="n">login</span><span class="o">-</span><span class="n">password</span><span class="w"> </span><span class="o">--</span><span class="n">region</span><span class="w"> </span><span class="n">us</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">helm</span><span class="w"> </span><span class="n">registry</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="o">--</span><span class="n">username</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="o">--</span><span class="n">password</span><span class="o">-</span><span class="n">stdin</span><span class="w"> </span><span class="n">public</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">aws</span>
<span class="n">helm</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">create</span><span class="o">-</span><span class="n">namespace</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="o">$</span><span class="n">ACK_SYSTEM_NAMESPACE</span><span class="w"> </span><span class="n">ack</span><span class="o">-$</span><span class="n">SERVICE</span><span class="o">-</span><span class="n">controller</span><span class="w"> </span>\
<span class="n">oci</span><span class="p">:</span><span class="o">//</span><span class="n">public</span><span class="o">.</span><span class="n">ecr</span><span class="o">.</span><span class="n">aws</span><span class="o">/</span><span class="n">aws</span><span class="o">-</span><span class="n">controllers</span><span class="o">-</span><span class="n">k8s</span><span class="o">/$</span><span class="n">SERVICE</span><span class="o">-</span><span class="n">chart</span><span class="w"> </span><span class="o">--</span><span class="n">version</span><span class="o">=$</span><span class="n">RELEASE_VERSION</span><span class="w"> </span><span class="o">--</span><span class="n">set</span><span class="o">=</span><span class="n">aws</span><span class="o">.</span><span class="n">region</span><span class="o">=$</span><span class="n">AWS_REGION</span>
</code></pre></div>

<p>Run the command and after a few moments you should see the following message:</p>
<div class="codehilite"><pre><span></span><code><span class="n">You</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">able</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">Amazon</span><span class="w"> </span><span class="n">Managed</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Prometheus</span><span class="w"> </span><span class="p">(</span><span class="n">AMP</span><span class="p">)</span><span class="w"> </span><span class="n">resources</span><span class="o">!</span>

<span class="n">The</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="s">&quot;cluster&quot;</span><span class="w"> </span><span class="n">mode</span><span class="p">.</span>

<span class="n">The</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">configured</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">manage</span><span class="w"> </span><span class="n">AWS</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nl">region:</span><span class="w"> </span><span class="s">&quot;us-east-1&quot;</span>

<span class="n">The</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">successfully</span><span class="w"> </span><span class="n">installed</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">used</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">provision</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">Amazon</span><span class="w"> </span><span class="n">Managed</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Prometheus</span><span class="w"> </span><span class="n">workspace</span><span class="p">.</span>
</code></pre></div>

<p>Let's now create a yaml file for provisioning the alert manager defnition and rule groups.
Save the below file as <code>rulegroup.yaml</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">prometheusservice</span><span class="o">.</span><span class="na">services</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">aws</span><span class="o">/</span><span class="n">v1alpha1</span>
<span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">RuleGroupsNamespace</span>
<span class="n">metadata</span><span class="o">:</span>
<span class="w">   </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="k">default</span><span class="o">-</span><span class="n">rule</span>
<span class="n">spec</span><span class="o">:</span>
<span class="w">   </span><span class="n">workspaceID</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Your</span><span class="w"> </span><span class="n">WORKSPACE</span><span class="o">-</span><span class="n">ID</span><span class="o">&gt;</span>
<span class="w">   </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="k">default</span><span class="o">-</span><span class="n">rule</span>
<span class="w">   </span><span class="n">configuration</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">     </span><span class="n">groups</span><span class="o">:</span>
<span class="w">     </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">example</span>
<span class="w">       </span><span class="n">rules</span><span class="o">:</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">record</span><span class="o">:</span><span class="w"> </span><span class="n">metric</span><span class="o">:</span><span class="n">linklocal_allowance_exceeded</span>
<span class="w">         </span><span class="n">expr</span><span class="o">:</span><span class="w"> </span><span class="n">node_net_ethtool</span><span class="o">{</span><span class="n">device</span><span class="o">=</span><span class="s2">&quot;eth0&quot;</span><span class="o">,</span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;linklocal_allowance_exceeded&quot;</span><span class="o">}</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">alert</span><span class="o">:</span><span class="w"> </span><span class="n">LinkLocalAllowanceExceeded</span>
<span class="w">         </span><span class="n">expr</span><span class="o">:</span><span class="w"> </span><span class="n">node_net_ethtool</span><span class="o">{</span><span class="n">device</span><span class="o">=</span><span class="s2">&quot;eth0&quot;</span><span class="o">,</span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;linklocal_allowance_exceeded&quot;</span><span class="o">}</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">         </span><span class="n">labels</span><span class="o">:</span>
<span class="w">           </span><span class="n">severity</span><span class="o">:</span><span class="w"> </span><span class="n">critical</span>

<span class="w">         </span><span class="n">annotations</span><span class="o">:</span>
<span class="w">           </span><span class="n">summary</span><span class="o">:</span><span class="w"> </span><span class="n">Packets</span><span class="w"> </span><span class="n">dropped</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">PPS</span><span class="w"> </span><span class="n">rate</span><span class="w"> </span><span class="n">allowance</span><span class="w"> </span><span class="n">exceeded</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">services</span><span class="w">  </span><span class="o">(</span><span class="n">instance</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span><span class="n">$labels</span><span class="o">.</span><span class="na">instance</span><span class="w"> </span><span class="o">}})</span>
<span class="w">           </span><span class="n">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;LinkLocalAllowanceExceeded is greater than 0&quot;</span>
</code></pre></div>

<p>Replace Your WORKSPACE-ID with the Workspace ID of the  workspace you are using. </p>
<p>Let's now configure the alert manager definition. Save the below fie as <code>alertmanager.yaml</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">apiVersion</span><span class="o">:</span><span class="w"> </span><span class="n">prometheusservice</span><span class="o">.</span><span class="na">services</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">aws</span><span class="o">/</span><span class="n">v1alpha1</span><span class="w">  </span>
<span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">AlertManagerDefinition</span>
<span class="n">metadata</span><span class="o">:</span>
<span class="w">  </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">alert</span><span class="o">-</span><span class="n">manager</span>
<span class="n">spec</span><span class="o">:</span>
<span class="w">  </span><span class="n">workspaceID</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Your</span><span class="w"> </span><span class="n">WORKSPACE</span><span class="o">-</span><span class="n">ID</span><span class="w"> </span><span class="o">&gt;</span>
<span class="w">  </span><span class="n">configuration</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">    </span><span class="n">alertmanager_config</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">route</span><span class="o">:</span>
<span class="w">         </span><span class="n">receiver</span><span class="o">:</span><span class="w"> </span><span class="n">default_receiver</span>
<span class="w">       </span><span class="n">receivers</span><span class="o">:</span>
<span class="w">       </span><span class="o">-</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">default_receiver</span>
<span class="w">          </span><span class="n">sns_configs</span><span class="o">:</span>
<span class="w">          </span><span class="o">-</span><span class="w"> </span><span class="n">topic_arn</span><span class="o">:</span><span class="w"> </span><span class="n">TOPIC</span><span class="o">-</span><span class="n">ARN</span>
<span class="w">            </span><span class="n">sigv4</span><span class="o">:</span>
<span class="w">              </span><span class="n">region</span><span class="o">:</span><span class="w"> </span><span class="n">REGION</span>
<span class="w">            </span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="o">|</span>
<span class="w">              </span><span class="n">alert_type</span><span class="o">:</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span><span class="o">.</span><span class="na">CommonLabels</span><span class="o">.</span><span class="na">alertname</span><span class="w"> </span><span class="o">}}</span>
<span class="w">              </span><span class="n">event_type</span><span class="o">:</span><span class="w"> </span><span class="o">{{</span><span class="w"> </span><span class="o">.</span><span class="na">CommonLabels</span><span class="o">.</span><span class="na">event_type</span><span class="w"> </span><span class="o">}}</span><span class="w">     </span>
</code></pre></div>

<p>Replace You WORKSPACE-ID with the Workspace ID of the new workspace, TOPIC-ARN with the ARN of an <a href="https://aws.amazon.com/sns/">Amazon Simple Notification Service</a> topic where you want to send the alerts, and REGION with the current region of the workload. Make sure that your workspace has permissions to send messages to Amazon SNS.</p>
<h2 id="visualize-ethtool-metrics-in-amazon-managed-grafana">Visualize ethtool metrics in Amazon Managed Grafana<a class="headerlink" href="#visualize-ethtool-metrics-in-amazon-managed-grafana" title="Permanent link">&para;</a></h2>
<p>Let's visualize the linklocal_allowance_exceeded within the Amazon Managed Grafana and build a dashboard. Configure the Amazon Managed Service for Prometheus as a datasource inside the Amazon Managed Grafana console. For instructions, see <a href="https://docs.aws.amazon.com/grafana/latest/userguide/AMP-adding-AWS-config.html">Add Amazon Prometheus as a datasource</a></p>
<p>Let's explore the metrics in Amazon Managed Grafana now:
Click the explore button, and search for ethtool:</p>
<p><img alt="Node_ethtool metrics" src="explore_metrics.png" /></p>
<p>Let's build a dashboard for the linklocal_allowance_exceeded metric by using the query <code>node_net_ethtool{device="eth0",type="linklocal_allowance_exceeded"}</code>. It will result in the below dashboard. </p>
<p><img alt="linklocal_allowance_exceeded dashboard" src="linklocal.png" /></p>
<p>We can clearly see that there were no packets dropped as the value is zero. You can further extend this by configuring alerts in Amazon Managed Grafana to send notifications to Slack, SNS, Pagerduty etc.</p>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["tabs"], "search": "../../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
    
  </body>
</html>